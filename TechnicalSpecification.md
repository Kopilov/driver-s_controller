# Электронный блок контроллера машиниста (логика, программная часть)

## Краткое описание

Электронный блок управления для контроллера [КС-305М](https://ross.com.ru/kontroller-ks-304m-ks-305m), совместимый с силовой частью.

Осуществляет преобразование состояния электронных органов управления (основного джойстика и тумблера реверса)
в зависимости от времени в эквивалент положения оригинальных рукояток (главного барабана и реверсивного барабана).
Учитываются допустимые переходы между состояниями в соответствии с оригинальной конструкцией.
Для каждого состояния, при их смене, осуществляется соответствующее переключение контакторов.

## Термины

*Главный барабан* — деталь оригинального контроллера, перемещается механически (вручную), имеет 18 положений
(из них одно нейтральное, 11 с положительным ускорением, 6 с отрицательным ускорением), осуществляет переключение силовых контакторов.

*Основной джойстик* — орган управления в виде джойстика с двумя положениями без фиксации, заменяет главный барабан.

*Реверсивный барабан* — деталь оригинального контроллера, перемещается механически (вручную), имеет три положения
(нейтральное, движение назад, движение вперёд), может перемещаться только при нейтральной позиции главного барабана.

*Тумблер реверса* — орган управления в виде тумблера с двумя положениями с фиксацией, заменяет реверсивный барабан.

*Эквивалентное состояние* — программный объект в памяти микроконтроллера, описывает состояние оригинального контроллера,
включает положения главного и реверсивного барабанов.

*Нажатие джойстика* — перевод из среднего положения в одно из крайних, 

*Период длительного нажатия* — время, при достижении которого (и кратного коорому) фиксируется событие длительного нажатия
при удержании джойстика в крайнем положении с момента нажатия.

*Длительное нажатие* — удержание джойстика в крайнем положении определённое время в течение периода длительного нажатия.

*Период автоматического (аварийного) переключения* — время между последовательными изменениями эквивалентного состояния
при необходимости достичь некоторого конкретного, например, аварийный тормоз или сброс на 0.

## Концепция

Входные устройства (основной джойстик, тумблер реверса) и выходные (реле, индикаторы) подключаются к микроконтроллеру,
в прототипе используется ATmega2560 (Arduino Mega) с отладочной платой Pro Mini.
Прошивка написана на C++ с использованием Arduino IDE и предполагает совместимость макетной платы с загрузчиком Arduino.

Основной компонент прошивки — конечный автомат, описывающий поведение контроллера.
Всего возможны 18 * 2 + 1 корректных состояний. А именно, 18 положений главного барабана при двух рабочих
положениях реверсивного и нулевое положение.

Положение каждого барабана может изменяться только с соседнего на соседнее,
при этом нулевое положение реверсивного ставится только при нулевом положении главного и, будучи выставленным,
не позволяет изменить положение главного на другое.

Диаграмма состояний:
```
        Эквивалентное положение главного барабана

       -6 5 4 3 2 1 0 1 2 3 4 5 6 7 8 9 10 11+

    -1  *-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*--*--*
                    |
     0              *
                    |
    +1  *-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*--*--*
Эквивалентное
положение
реверсивного
барабана

```

## Требования

При нажатии джойстика изменяется эквивалентное положение главного барабана на 1 (в большую или меньшую сторону в зависимости от нажатия)
при условии, что данное состояние существует и переход в него возможен. Если эквивалентное положение реверсивного барабана нулевое,
он переводится в крайнее, соответствующее положению тумблера реверса, при этом эквивалентное положение главного барабана не меняется.

При длительном нажатии поведение аналогичное, при каждом наступлении кратного периода.

При переключении тумблера реверса  
* если эквивалентное положение главного барабана 1 и более (ход), переключение реверса не производится,
главный барабан перемещается на минимальное значение (аварийный тормоз) с периодом автоматического переключения;
* если эквивалентное положение главного барабана -1 и менее (тормоз), продолжаем тормозить (так же не снимаемся с аварийного тормоза);
* если эквивалентное положение главного барабана 0 (стоянка), переключить эквивалентное положение реверсивного барабана на 0.
Если уже стоит нулевое эквивалентном положении реверсивного барабана, то ничего не происходит до нажатия основного джойстика, при котором положение тумблера будет учтено.
